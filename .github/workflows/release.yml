name: Release and Publish

on:
  push:
    tags:
      - "cli-v*"
      - "n8n-v*"

jobs:
  publish-cli:
    if: startsWith(github.ref, 'refs/tags/cli-v')
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          registry-url: "https://registry.npmjs.org"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile || pnpm install --no-frozen-lockfile

      - name: Run CLI tests
        run: pnpm run test --filter=packages/cli

      - name: Build CLI
        run: pnpm run build --filter=packages/cli

      - name: Test CLI execution
        run: |
          chmod +x packages/cli/dist/index.js
          ./packages/cli/dist/index.js --help

      - name: Update CLI package version from tag
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/cli-v}
          cd packages/cli
          npm version $TAG_VERSION --no-git-tag-version

      - name: Publish CLI to npm
        run: cd packages/cli && npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create GitHub Release for CLI
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: nocioun CLI ${{ github.ref }}
          body: |
            ## üöÄ nocioun CLI Release

            ### Installation
            ```bash
            npx nocioun --help
            ```

            ### Features
            - Google Contacts Ïó∞Îèô
            - Notion Îç∞Ïù¥ÌÑ∞Î≤†Ïù¥Ïä§ ÎèôÍ∏∞Ìôî
            - OAuth Ïù∏Ï¶ù ÏßÄÏõê
          draft: false
          prerelease: false

  publish-n8n:
    if: startsWith(github.ref, 'refs/tags/n8n-v')
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v4
        with:
          version: latest

      - name: Use Node.js 20.x
        uses: actions/setup-node@v4
        with:
          node-version: "20.x"
          registry-url: "https://registry.npmjs.org"
          cache: "pnpm"

      - name: Install dependencies
        run: pnpm install --frozen-lockfile || pnpm install --no-frozen-lockfile

      - name: Build n8n nodes
        run: pnpm run build --filter=packages/n8n-nodes

      - name: Update n8n package version from tag
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/n8n-v}
          cd packages/n8n-nodes
          npm version $TAG_VERSION --no-git-tag-version

      - name: Publish n8n nodes to npm
        run: cd packages/n8n-nodes && npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create GitHub Release for n8n nodes
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref }}
          release_name: n8n-nodes-nocioun ${{ github.ref }}
          body: |
            ## üöÄ n8n Nodes Release

            ### Installation
            ```bash
            npm install n8n-nodes-nocioun
            ```

            ### Nodes
            - Google Contacts Node
            - Notion Node
            - Ïù∏Ï¶ù Ï†ïÎ≥¥ Í¥ÄÎ¶¨
          draft: false
          prerelease: false
